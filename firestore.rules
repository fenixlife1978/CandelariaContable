/**
 * This ruleset implements an "Authenticated Universal Access" model.
 *
 * Core Philosophy:
 * The security model is intentionally permissive, granting any authenticated user
 * full administrative privileges across the entire database. The primary security
 * boundary is user authentication; if a user is signed in, they are trusted
 * completely. Unauthenticated access is fully denied.
 *
 * Data Structure:
 * The data is organized into flat, top-level collections for incomes, expenses,
 * and loan summaries. There is no user-specific nesting or data ownership,
 * reflecting the universal access model.
 *
 * Key Security Decisions:
 * - Universal Permissions: Any user who has successfully signed in can read, create,
 *   update, and delete any document in any collection.
 * - No Ownership: The concept of document ownership is intentionally omitted.
 *   This allows any authenticated user to manage all data.
 * - Authentication is the Only Gate: The single check for all operations is
 *   whether the user is signed in (`request.auth != null`).
 *
 * WARNING: This model is suitable for applications where all users are
 * trusted administrators or for early-stage prototypes. It is not recommended
 * for multi-tenant applications with untrusted users, as there is no data
 * isolation between users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated. This is the primary security
     * gate for the entire database.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Allows any authenticated user to manage income records.
     * @path /incomes/{incomeId}
     * @allow An authenticated user `(auth.uid: 'user_abc')` can create an income record `(create)`.
     * @deny An unauthenticated user `(auth: null)` is denied from reading any income record `(get)`.
     * @principle Enforces a single security boundary: the user must be signed in.
     */
    match /incomes/{incomeId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to manage expense records.
     * @path /expenses/{expenseId}
     * @allow An authenticated user `(auth.uid: 'user_xyz')` can delete any expense record `(delete)`.
     * @deny An unauthenticated user `(auth: null)` is denied from listing expense records `(list)`.
     * @principle Enforces a single security boundary: the user must be signed in.
     */
    match /expenses/{expenseId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to manage AI-generated loan summaries.
     * @path /loanSummaries/{loanSummaryId}
     * @allow An authenticated user `(auth.uid: 'user_123')` can update any loan summary `(update)`.
     * @deny An unauthenticated user `(auth: null)` is denied from creating a loan summary `(create)`.
     * @principle Enforces a single security boundary: the user must be signed in.
     */
    match /loanSummaries/{loanSummaryId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to manage monthly financial closures.
     * @path /monthlyClosures/{closureId}
     * @allow An authenticated user `(auth.uid: 'user_456')` can create a new monthly closure record.
     * @deny An unauthenticated user `(auth: null)` is denied from reading any closure record.
     * @principle Enforces a single security boundary: the user must be signed in.
     */
    match /monthlyClosures/{closureId} {
        allow read, write: if isSignedIn();
    }
    
    /**
     * @description Allows any user to read the company profile, but only authenticated users to write.
     * @path /companyProfile/{profileId}
     * @allow An unauthenticated user `(auth: null)` can read the company profile for the login page.
     * @allow An authenticated user `(auth.uid: 'user_789')` can create and update the company profile.
     * @deny An unauthenticated user `(auth: null)` is denied from writing the company profile.
     */
    match /companyProfile/{profileId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
  }
}
