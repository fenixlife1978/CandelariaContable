/**
 * This ruleset implements a role-based access control model where only
 * administrators have write privileges.
 *
 * Core Philosophy:
 * The security model grants universal read access to authenticated users, but
 * restricts all data modification (create, update, delete) to users who have
 * a custom claim `admin: true` on their authentication token. Unauthenticated
 * access is fully denied, except for reading the company profile.
 *
 * Data Structure:
 * The data is organized into flat, top-level collections. There is no
 * user-specific nesting, as the access control is based on roles, not ownership.
 *
 * Key Security Decisions:
 * - Admin-Only Writes: Any user attempting to create, update, or delete a document
 *   in any collection must be an administrator.
 * - Authenticated Reads: Any authenticated user can read data from the main
 *   collections. The company profile is publicly readable for the login page.
 * - Role-Based Control: The primary check for write operations is `isAdmin()`,
 *   which inspects the custom claims on the user's token.
 *
 * WARNING: This model assumes that custom claims are being securely set and managed
 * via a trusted server environment (e.g., Cloud Functions).
 *
 * Force redeploy: 2024-08-01 12:00:00 UTC
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has the 'admin' custom claim.
     * This is the primary gate for all write operations.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Allows authenticated users to read, but only admins to write.
     * @path /incomes/{incomeId}
     */
    match /incomes/{incomeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Allows authenticated users to read, but only admins to write.
     * @path /expenses/{expenseId}
     */
    match /expenses/{expenseId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Allows authenticated users to read, but only admins to write.
     * @path /loanSummaries/{loanSummaryId}
     */
    match /loanSummaries/{loanSummaryId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Allows authenticated users to read, but only admins to write.
     * @path /monthlyClosures/{closureId}
     */
    match /monthlyClosures/{closureId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    /**
     * @description Allows any user to read the company profile, but only admins to write.
     * @path /companyProfile/{profileId}
     */
    match /companyProfile/{profileId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
